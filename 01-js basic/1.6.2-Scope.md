# 作用域链

[scope]中存储的执行期上下文对象的集合，这个集合呈链接，我们 把这种链式链接叫 `作用域链接`

__运行期上下文__ 

> 当函数执行时，会创建一个称为 `执行期上下文` 的内部对象
> 
> 一个执行期上下文定义了一个函数执行时的环境，函数每次执行时对应的执行上下文都是独一无二的
> 
> 多次调用一个函数会导致创建多个执行上下文，当函数执行完毕，执行上下文被销毁

__查找变量__

> 从作用域链的顶端依次向下查找

``` javascript


function a() {

    function b() {
    
        var b = 234;
    }
    
    var a = 123;
    
    b();
}

var global = 100;

a();


```

``` javascript


// Step - 1: function a() {}; `被定义时`，发生如下过程 

a.[[scope]].executionOrder {

    0 : GO {}
}


a.[[scope]] -> scope chain {                

    scope chain {
    
        0 : GO {
        
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),                 
            global   : 100
        }
        
    } 
}


```

``` javascript


// Step - 2: function a() {}; `被执行时`，发生如下过程 

a.[[scope]].executionOrder {

    0 : a.AO {},
    1 : GO {}
}


a.[[scope]] -> scope chain {

    scope chain {
    
        0 : AO {
        
            this      : window,
            arguments : [],
            a         : 123,
            b         : (function)
        },
        
        1 : GO {
                
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),
            global   : 100
        }
        
    }
}


```

``` javascript


// Step - 3: function b() {} `创建时候`，发生如下过程

b.[[scope]].executionOrder {

    0 : a.AO {},
    1 : GO {}
}


b.[[scope]] -> scope chain {

    scope chain {
    
        0 : AO {
        
            this      : window,
            arguments : [],
            a         : 123,
            b         : (function)
        },
        
        1 : GO {
                
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),
            global   : 100
        }
        
    }
}


```

``` javascript


// Step - 4: function b() {}，`被执行时`，发生如果过程

b.[[scope]].executionOrder {

    0 : b.AO {},
    1 : a.AO {},
    2 : GO {}
}


b.[[scope]] -> scope chain {

    scope chain {
    
        0 : b.AO {
        
            this      : window,
            arguments : [],
            b         : 234
        },
        
        1 : a.AO {
                
            this      : window,
            arguments : [],
            a         : 123,
            b         : (function)
        },
        
        2 : GO {
                
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),
            global   : 100
        }
        
    }
}


```

``` javascript


// Step - 5: function b() {}，`执行完，销毁运行时执行上下文`，发生如果过程

b.[[scope]].executionOrder {

    0 : a.AO {},
    1 : GO {}
}


b.[[scope]] -> scope chain {

    scope chain {
    
        0 : a.AO {
                
            this      : window,
            arguments : [],
            a         : 123,
            b         : (function)
        },
        
        1 : GO {
                
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),
            global   : 100
        }
        
        {   // delete `b.AO {}` link，wait for next link( new b.AO {} )
                
            this      : window,
            arguments : [],
            b         : 234
        }
        
    }
}


```

``` javascript

// Step - 6: function b() {}，`执行完，销毁运行时执行上下文`，发生如果过程

b.[[scope]].executionOrder {

    0 : GO {}
}


b.[[scope]] -> scope chain {

    scope chain {
    
        1 : GO {
                
            this     : window,
            window   : (object),
            document : (object),
            a        : (function),
            global   : 100
        }
        
        {   // delete `b.AO {}` link，wait for next link( new b.AO {} )
        
            this      : window,
            arguments : [],
            b         : 234
        }
     
        {   // delete `a.AO {}` link，wait for next link( new a.AO {} )
         
            this      : window,
            arguments : [],
            a         : 123,
            b         : (function)
        },

    }
}



```


__Example:__


``` javascript


function a() {

    function b() {
    
        function c() {
        
        }
        
        c();

    }
    
    b();

}

a();


```

``` javascript


a.[[scope]] {           // a defined
 
    0 : GO

}

a.[[scrop]] {           // a doing
 
    0 : a.AO,
    1 : GO
    
}

b.[[scope]] {           // b defined

    0 : a.AO,
    1 : GO

}

b.[[scope]] {           // b doing

    0 : b.AO,
    1 : a.AO,
    2 : GO

}

c.[[scope]] {           // c defined

    0 : b.AO,
    1 : a.AO,
    2 : GO

}

c.[[scope]] {           // c doing

    0 : c.AO,
    1 : b.AO,
    2 : a.AO,
    3 : GO

}


```


## 闭包

> 当内部函数被保存到外部时，将会生成闭包，闭包会导致原有作用域链不释放，造成内存泄漏
> 
> 内存泄漏: 不断占用内存，剩余内存将一点一点减少

``` javascript
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


function a() {

    function b() {                  

        var bbb = 234;

        console.log(aaa);
    }

    var aaa = 123;

    return b;
}

var glob = 100;

var demo = a();

demo();


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


/**
 * function a() {} 执行时
 * 
 * function b() {} 已定义，未执行，保存到外部
 */

a.[[scope]] == b.[[scope]] -> scope chain {

    0 : AO {
    
        this      : window,
        arguments : [],
        aaa       : 123,
        b         : (function)
    },
    
    1 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        a        : function,
        glob     : 100,
        demo     : (function)
    }

}


//- -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  - -//


/**
 * function a() {} 执行完，销毁 AO {}
 * 
 * function b() {} 已定义，未执行 => 存储到函数外部
 */
 
a.[[scope]] -> scope chain {            //销毁 AO {}

    0 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        a        : function,
        glob     : 100,
        demo     : (function)
    }
    
}


glob = b.[[scope]] -> scope chain {

    0 : AO {
    
        this      : window,
        arguments : [],
        aaa       : 123,
        b         : (function)
    },
    
    1 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        a        : function,
        glob     : 100,
        demo     : (function)
    }

}


//- -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  -  - -//


/**
 * function b() {} 执行，新建 AO {} 
 * 
 */

new b.[[scope]] -> scope chain {

    0 : AO {
    
        this      : window,
        arguments : [],
        aaa       : 123,
        b         : (function)
    },
    
    1 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        a        : function,
        glob     : 100,
        demo     : (function)
    }

}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

``` javascript
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// Example

function a() {

    var num = 100;
    
    function b() {
    
        num ++;
        
        console.log(num);
    }
    
    return b;
}

var demo = a();

demo;
demo;


demo = b.[[scope]] -> scope chain {

    0 : b.AO {
        
        num : ++
    },
    
    1 : a.AO {
    
        this      : window,
        arguments : [],
        num       : 100
    },
    
    2 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        demo     : (function)
    }
}


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


execute demo; 

new b.[[scope]] -> scope chain {

    0 : b.AO {
        
        num : ++
    },
    
    1 : a.AO {
    
        this      : window,
        arguments : [],
        num       : 100                 // 调用 a.AO {} 中 的 num
    },
    
    2 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        demo     : (function)
    }
    
}

num = 100; -> num ++; => demo;                        // 101


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


execute demo; 

new b.[[scope]] -> scope chain {

    0 : b.AO {
        
        num : ++
    },
    
    1 : a.AO {
    
        this      : window,
        arguments : [],
        num       : 101                 // 调用 上次执行后改变的 num
    },
    
    2 : GO {
    
        this     : window,
        window   : (object),
        document : (object),
        demo     : (function)
    }
    
}

num = 101; -> num ++; => demo;                        // 102


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

``` javascript
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * Example
 * 
 * 实现公有变量 -- 函数累加器
 */

function add() {

    var count = 0;
    
    function demo() {
    
        count ++;
        
        console.log(count);
    }

    return demo;
}

var counter = add();


counter();      // 1
counter();      // 2
counter();      // 3
counter();      // 4
counter();      // 5


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

``` javascript
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * Example
 * 
 * 用作缓存( 存储结构 )
 */
 
function test() {

    var num = 100;
    
    function a() {
    
        num ++;

        console.log(num);
    }
    
    function b() {
    
        num --;
        
        console.log(num);
    }
    
    return [a, b];
}

var myArr = test();

myArr[0];           // 101
myArr[1];           // 100


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


myArr = test.[[scope]] --> scope chain {

    0 : [a.AO {
    
            this      : window,
            arguments : [],
            num       : ++
        },
    
        b.AO {
        
            this      : window,
            arguments : [],
            num       : --
    }],
    
    1 : GO {
        
        this     : window,
        window   : (object),
        document : (object),
        num      : 100,
        myArr    : (function)
    }
}

//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


execute myArr[0];

myArr[0] = test.[[scope]] --> scope chain {

    0 : myArr[0].AO {
    
        this      : window,
        arguments : [],
        num       : ++
    },
    
    1 : GO {
        
        this     : window,
        window   : (object),
        document : (object),
        num      : 100,                 // 调用 GO {} 中的 num
        myArr    : (function)
    }
}

num ++; => myArr[0];                    // 101


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - //


execute myArr[1];

myArr[1] = test.[[scope]] --> scope chain {

    0 : myArr[1].AO {
    
        this      : window,
        arguments : [],
        num       : ++
    },
    
    1 : GO {
        
        this     : window,
        window   : (object),
        document : (object),
        num      : 101,                 // 调用 GO {} 中已更改的 num 
        myArr    : (function)
    }
}

num ++; => myArr[1];                    // 100


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```












































