# Webpack

## basic

#### webpack introduction

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * webpack
 * 
 * 
 */

1) webpack 使用层面很简单，原理很复杂

2) webpack 生态圈很繁荣，有海量第三方库


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 浏览器端的模块化                     // 工程问题
 * 
 * 
 */

1) 效率问题: 精确的模块划分，造成了更多的 JS 文件，导致 更多 的请求，降低了页面的访问效率

2) 兼容性问题: 浏览器目前仅支持 ES6 模块化标准，并且还存在兼容性问题

3) 工具问题: 浏览器不支持 npm 下载的第三方包


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 根本原因
 * 
 * 
 */

// node 环境中

运行的 JS 文件在本地，因此可以本地读取文件，效率必浏览器远程传输高很多


// 浏览器 环境中

开发状态( devtime ) 和 运行状态( runtime ) 的侧重点不一样


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


开发状态( devtime )

1) 模块划分越细越好

2) 支持多种模块化标准

3) 支持 npm 或 其他包管理器 下载的模块

4) 可以解决其他工程化问题


运行状态( runtime )

1) 文件越少越好

2) 文件体积越小越好

3) 代码内容越乱越好( 防止他人抄袭 )

4) 所有浏览器都要兼容

5) 可以解决其他运行时的问题，主要是执行效率问题


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


        + ---- devtime ---- +                               + ---- runtime ----- +
        |                   |                               |                    |
        |                   |                               |                    |
        |     Module-1      | =====> Construct Tool ======> |                    |
        |                   |                               |                    |
        |     Module-2      |          webpack              |                    |
        |                   |          grunt                |     target.js      |
        |     Module-3      |          gulp                 |                    |
        |                   |          browseerify          |                    |
        |     Module-N      |          fis                  |                    |
        |                   |          ...                  |                    |
        |                   |                               |                    |
        + ----------------- +                               + ------------------ +


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### webpack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * 打包所有的脚本
 * 
 * 
 * 通过开发时入口模块为起点，分析出所有依赖关系
 * 
 * 然后( 合并，压缩 ... )，最终生成运行时态的文件
 */


 .js
 
         .js
         
 .hbs            .png                                
                                                     .js     .css
         .sass           ======> webpack =======>
                                                     .jpg    .png        
 .cjs            .jpg             node                        
 
         .sass
         
 .sass
 
 Modules with dependencies                           static assets


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


/**
 * webpack 的特点
 * 
 * 
 */

1) 为前端工程化而生

   webpack 致力于解决前端工程化( 基于浏览器环境 )


2) 简单易用

   支持零配置( 无需任何代码配置，即可使用 )


3) 强大的生态
   
   webpack 非常灵活，可扩展( 第三方库丰富 )，本身功能并不多，


4) 基于 node.js

   webpack 在构建过程中需要读取文件，构建过程中基于 node 环境中
   

5) 基于模块化

   webpack 在构建过程中需要分析依赖关系( 基于模块化入口文件分析依赖 )
   
   支持各种模块化标准( CommonJS，ES6，Module )


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### install webpack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * install webpack                  // 全局安装
 * 
 * 
 * 建议本地根据项目安装( 全局安装会导致所有工程的 webpack 版本都是一样 )
 */


npm i -D webpack webpack-cli


// wepack: 核心包( 包含了 webpack 构建过程中用到的所有 API )
// 
// webpack-cli: 提供命令行调用 webpack 核心包中的 API( 用于构建 webpack )


//-------------------------------------------------------------------------------------------------------------------//


/**
 * execute webpack
 * 
 * 
 */


[npx] webpack


默认情况下: webpack 会以当前工程根目录下的 ./src/index.js 为入口文件分析模块依赖关系

          将打包好的代码放置到当前工程根目录下的 ./dist/main.js 中


//-------------------------------------------------------------------------------------------------------------------//


/**
 * webpack mode
 * 
 * 
 * 设置 webpack 打包环境
 */


webpack --mode=development

webpack --mode=development --watch          // 添加监控，实时改变文件内容即重新执行


1) development

2) production                               // default mode



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### Module compatibility

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * CommonJS
 * 
 * 
 */

exports.key = {

    prop,
    method
};

const moudle = require('./demo.js');

module.exports = {

}


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


/**
 * ES6 Moudle
 * 
 * 
 */

export { propName, methodName };

import { exportListItemItem } form "exportUrl";


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 无论模块之间遵循何种导入导出规范，webpack 都可以很好的兼容
 * 
 * 
 */


1) CommonJs export + ES6 import

2) ES6 export + CommonJs import

3) ...


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

## content

#### myMain

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


(function (modules) {               // webpackBootstrap

    // The module cache
    var installedModules = {};

    // The require function
    function __webpack_require__(moduleId) {

        // Check if module is in cache
        if (installedModules[moduleId]) {
        
            return installedModules[moduleId].exports;
        }

        // Create a new module (and put it into the cache)
        var module = installedModules[moduleId] = {

            i: moduleId,
            l: false,
            exports: {}
        };

        // Execute the module function
        modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);

        // Flag the module as loaded
        module.l = true;

        // Return the exports of the module
        return module.exports;
    }

    // /**
    //  * 处理模块导入导出的兼容
    //  *
    //  *
    //  */
    //
    // // // expose the modules object (__webpack_modules__)
    // __webpack_require__.m = modules;
    //
    // // expose the module cache
    // __webpack_require__.c = installedModules;
    //
    // // define getter function for harmony exports
    // __webpack_require__.d = function (exports, name, getter) {
    //
    //     if (!__webpack_require__.o(exports, name)) {
    //
    //         Object.defineProperty(exports, name, {enumerable: true, get: getter});
    //     }
    // };
    //
    // // define __esModule on exports
    // __webpack_require__.r = function (exports) {
    //     if (typeof Symbol !== 'undefined' && Symbol.toStringTag) {
    //
    //         Object.defineProperty(exports, Symbol.toStringTag, {value: 'Module'});
    //     }
    //     Object.defineProperty(exports, '__esModule', {value: true});
    // };
    //
    // // create a fake namespace object
    // // mode & 1: value is a module id, require it
    // // mode & 2: merge all properties of value into the ns
    // // mode & 4: return value when already ns object
    // // mode & 8|1: behave like require
    // __webpack_require__.t = function (value, mode) {
    //     if (mode & 1) value = __webpack_require__(value);
    //     if (mode & 8) return value;
    //     if ((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
    //     var ns = Object.create(null);
    //     __webpack_require__.r(ns);
    //     Object.defineProperty(ns, 'default', {enumerable: true, value: value});
    //     if (mode & 2 && typeof value != 'string') for (var key in value) __webpack_require__.d(ns, key, function (key) {
    //         return value[key];
    //     }.bind(null, key));
    //     return ns;
    // };
    //
    // // getDefaultExport function for compatibility with non-harmony modules
    // __webpack_require__.n = function (module) {
    //
    //     var getter = module && module.__esModule ?
    //         function getDefault() {
    //             return module['default'];
    //         } :
    //         function getModuleExports() {
    //             return module;
    //         };
    //     __webpack_require__.d(getter, 'a', getter);
    //     return getter;
    // };
    //
    // // Object.prototype.hasOwnProperty.call
    // __webpack_require__.o = function (object, property) {
    //     return Object.prototype.hasOwnProperty.call(object, property);
    // };
    //
    // // __webpack_public_path__
    // __webpack_require__.p = "";

    // Load entry module and return exports
    return __webpack_require__(__webpack_require__.s = "./src/index.js");

})({

    "./src/index.js": (function (module, exports) {

        /**
         * eval();              // 浏览器执行时，会将 eval(); 中的代码单独放在一个环境中执行，若报错，便于查看
         *
         * //# sourceURL=webpack:///./src/index.js?         // 设置浏览器报错路径规则
         */

        eval("n\n\n//# sourceURL=webpack:///./src/index.js?");
    })
});


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### webpack.config.js

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * webpack.config.js            // 指定 webpack 配置文件
 * 
 * 
 * 参与编译过程( node 环境中运行 )，所以配置文件仅支持有效的 node 代码( 仅支持 CommonJS 规范 )
 * 
 * 配置文件中必须是有效的 node 代码( 不支持 ES6 即其他 模块规范 )
 */


cmd: webpack --config config.js 


//-------------------------------------------------------------------------------------------------------------------//


1) mode: string;        // 指定编译结果代码运行环境，影响 webpack 对编译结果代码的格式处理


2) entry: string;       // 指定文件入口


3) output: object;      // 指定编译结果文件


4) ...


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


// 默认配置

module.export = {

    mode: 'devolopment',
    
    entry: './src/index.js',
    
    output: {
    
        fileName: 'main.js',
        
        ...
    }
};


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### Compile process of webpack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


    | - - - - - 初始化 --------------------> 编译 ---------------------> 输出 - - - - - - | 

    + -------------------------- +                                                                                                             
    |                            |                                                 
    |   .js                      |                                                    
    |                            |                                                            
    |           .js              |                                                                     
    |                            |                           + ------------------------- +
    |   .hbs            .png     |                           |                           |
    |                            |                           |       .js     .css        |
    |           .sass            |  ======> webpack ======>  |                           |
    |                            |                           |       .jpg    .png        |
    |   .cjs            .jpg     |                           |                           |
    |                            |                           + ------------------------- +
    |           .sass            |                                                                     
    |                            |                                                                    
    |   .sass                    |                                                                
    |                            |                                              
    + -------------------------- +                                                                                                             

       Modules with dependencies                                      static assets


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 初始化
 * 
 * 
 * webpack 会将 CLI 参数，配置文件，默认配置等进行融合配置，形成最终的 配置对象
 */

配置处理过程，依托于第三方库  yargs 


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 编译
 * 
 */

//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


        + ------------ main chunk -------------- +
        |                                        |
        |                                        |
        |      + ---- index module ---- +        |
        |      |                        |        |
        |      |     ./src/index.js     |        |
        |      |                        |        |
        |      + ---------------------- +        |
        |                                        |
        |                                        |
        + -------------------------------------- +

/**
 * step-1: 创建 chunk
 * 
 * 
 * chunk 是 webpack 内部构建过程中的一个概念( 表示通过某个入口，分析并获取依赖 )
 */

默认根据入口模块( default: ./src/index.js )创建 chunk

每个 chunk 至少具有两个属性

chunk {

    'name': 'main',                 // 默认为 main
    'id': 'xxx'                     // 开发环境时 value: name; 相同，生产环境时 value: number;( 从零开始 )
}


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


    chunk {         // 用于记录模块转换后的代码
        
        'moduleId': 'tranformedCode'
        './scr/index.js': 'xxxxxxx',
        ...
    }
                        /\
                       /||\
                        ||
                      检查记录
           
    入口 ----> 入口模块文件 -------> 已记录则结束 ---> 读取文件内容 --> AST( 抽象语法树 ) ---> 将依赖关系保存 ------------>>
                                  未记录则继续                        语法分析        ( 保存至 dependencies 文件中 )        
                                                                   树形结构遍历      ( 获取 require(); 中 )
                                                                   获取所有依赖      ( 所对应的完整路径作为 moduleId )


    >> 替换依赖函数 ----------------------------------------> 保存转换后的模块代码 ----------------------------> 入口
    require('a'); =>  __webpack_require('./src/a.js');
                                                                              根据 dependencies 中的依赖关系
                                                                              递归加载所有依赖模块


/**
 * step-2: 构建所有依赖模块
 * 
 */

1) 读取入口文件

   分析是否已有保存转换后的代码


2) 抽象语法树，利用 dependencies 记录所有依赖关系

   替换依赖函数 require('a'); =>  __webpack_require('./src/a.js');


3) 利用保存的依赖关系，递归加载所有依赖模块文件

   获取所有转换后的代码，并记录于 chunk assets 中 


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


/**
 * step-3
 * 
 * 
 * 根据 step-2 中的 chunk {} 生成 chunk assets {}
 */

chunk { // 用于记录模块转换后的代码            main chunk { // 最终合并的 js 模块代码        assets {
                                                                                                
    'moduleId': 'tranformedCode'    ===>        'modulesId': 'finallyCode',    =>           main chunk hash,
    './src/index.js': 'xxxxxxx',                './dist/main.js': 'xxxxxx',                 sub  chunk hash,
    './src/a.js': 'xxxxxx'                      './dist/main.js.map': 'xxx'                 ...
    ...                                         ...
}                                           }                                          }
            
                                            main chunk hash: xxxxxxxxxxxxxx            hash: xxxxxxxxxx
                                            ( 用于判断文件是否改变 )

                                            sub chunk {                                 
                                                                                        
                                                ...
                                            }
                                            
                                            sub chunk hash: xxxxxxxxxxxxxxx
                                            
                                            ...             


// chunk hash: 根据所有 chunk assets 的内容生成的一个 hash 字符串
// hash( 一种算法，有很多分类 ): 将一个任意长度的字符串转换为一个固定长度的字符串，并且可以保证原始内容不变



//-------------------------------------------------------------------------------------------------------------------//


/**
 * 输出
 * 
 * 
 * webpack 利用 node 中的  fs模块( 文件处理模块 )
 * 
 * 根据编译产生的 assets，生成相应的文件
 */


assets {

    main chunk hash,
    sub  chunk hash,
    ...
}

hash: xxxxxxxxxx


//-------------------------------------------------------------------------------------------------------------------//


/**
 * 涉及术语
 * 
 * 
 */

1) module

   模块，分割的代码单元，webpack 中的模块可以是任何内容的文件，不仅限于 JS


2) chunk

   webpack 内部构建模块的块，一个 chunk 包含多个模块，这些 模块是从入口模块中通过依赖分析所获取


3) bundle

   chunk 构建好模块后会生成 chunk 资源清单，清单中的每一项即是一个 bundle，可以认为 bundle 是最终生成的文件


4) hash

   最终的资源清单( 所有内容联合生成的 hash 值 )


5) chunkhash

   chunk 生成的资源清单内容联合生成的 hash 值


6) chunkname

   chunk 名称，若没有则使用 main


7) id

   通常指 chunk 的唯一编号，如果在开发环境下构建，和 chunkname 相同，若在生产环境下构建，则使用一个从零开始的数字进行编号


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```

#### input and output of webpack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

pwd
/**
 * 
 * 
 * 
 */


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```


## devtool config

#### what is source-map

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


很多时候并不会直接运行源码( 合并，压缩，转换等 )，实际运行的是转换后的代码

实际运行转换后的代码，在调试过程中，发生错误时，无法查看在源码中的错误信息


//-------------------------------------------------------------------------------------------------------------------//


/**
 * source map                   // 与 webpack 无关
 * 
 * 
 * source map 是一个配置，配置中不仅记录了所有源码内容，还记录了转换后的代码对应关系
 */


1) source map 应在开发环境中使用

   作为一种调试手段


2) source map 不应该在生产环境中使用

   source map 文件一般较大，会导致额外网络传输，容易暴露源码
   
   ( 若在生产环境中使用，需要处理网路问题和源码暴露问题 )


//-------------------------------------------------------------------------------------------------------------------//


                    + ----------- +
                    |             |
                    |   Browser   |
                    |             |
                    + ----------- +
                           |
                        request                     // 浏览器请求服务器，获取转换后的代码
                           |
        + ------------------------------------ +
        |                                      |
        |   #$#@(^&@!*(!$&#*($!$^!(#&$#*(!^^   |    // 转换后的代码: 无空格，无换行，便捷的变量名等，难以阅读
        |   !#*()#!&*#()!&$)!&$($*#()!#*(#$*   |    
        |   (!*&$#$!$*$#!&*$(#& ...            |
        |                                      |
        |   //# sourceMappinggURL=bundle.map   |    // 浏览器发现有 source map
        |                                      |
        + ------------------------------------ +
                           |
                      request again                 // 再次请求
                           |
        + ------------- bundle.js ------------ +
        |                                      |    
        |    source code                       |    // source map: 记录了源码
        |                                      |                   记录了源码和转换后代码的对应关系
        |    source code <--> result code      |                   ...
        |    ...                               |    
        |                                      |    
        + ------------------------------------ +


//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


                    + ----------- +
                    |             |
                    |   Browser   |
                    |             |
                    + ----------- +
                           |
                        request                     // 请求资源   
                           |
        + ------------------------------------ +
        |                                      |
        |   #$#@(^&@!*(!$&#*($!$^!(#&$#*(!^^   |        
        |   !#*()#! [Error] &*$($*#()!#*(#$*   |    // 发现错误 [Error]          
        |   (!*&$#$!$*$#!&*$(#& ...            |
        |                                      |
        |   //# sourceMappinggURL=bundle.map   |    // 发现 sourceMap 绑定文件        
        |                                      |
        + ------------------------------------ +
                           |
                      request again                 // 再次请求 bundle.js      
                           |
        + ------------- bundle.js ------------ +
        |                                      |          
        |    source code                       |        
        |                                      |        
        |    source code <--> result code      |        
        |    ...                               |          
        |                                      |          
        + ------------------------------------ +
                           |
                           |
         根据 bundle.js ，返回的源码中相应位置的错误


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```pwdnpm

#### devtool in webpack

``` javascript
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/**
 * devtool                  // webpack 默认支持 source map
 * 
 * 
 * 使用 devtool 在 webpac.config.js 中设置不同开发环境中的配置，用于改变调试时获取不同的关联信息
 */


//-------------------------------------------------------------------------------------------------------------------//

/**
 * development mode         // 建议使用: eval-source-map
 * 
 * 
 * 若需要将 source map 用于开发环境，则需要注意
 */

1) 根据配置的不同，调试时报错显示的位置不同( 源文件，打包后的文件等 )

2) 根据配置的不同，调试时报错的精确成都不同( 精确，错误行等 )

3) 根据配置的不同，调时或打包时效率不同

4) ...

//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -//


/**
 * production mode
 * 
 * 
 * 若需要将 source map 部属到成产环境，则需要注意
 */

1) 避免普通用户访问

2) 应仅当作错误调试工具

3) 避免暴露源码

4) ...


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
```








































































